<!DOCTYPE html>
<html lang="en" class="bg-gray-50 text-gray-900">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parallel Bible</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.26.0/dist/index.min.js"></script>

  <!-- Make body a flex column and fill the viewport -->

<body class="flex flex-col min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">

  <!-- Main content: flex-grow so footer stays visible at bottom -->
  <div class="flex-grow max-w-5xl mx-auto p-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
      <h1 class="text-2xl font-semibold">
        Parallel Bible results for "<span id="queryWord">book</span>"
      </h1>
      <label class="inline-flex items-center cursor-pointer text-sm">
        <input type="checkbox" id="darkModeToggle" class="sr-only" />
        <span class="mr-2">Dark Mode</span>
        <div class="relative">
          <div class="w-10 h-4 bg-gray-400 rounded-full shadow-inner dark:bg-gray-600"></div>
          <div
            class="dot absolute w-6 h-6 bg-white border rounded-full top-[-6px] left-0 transition-transform duration-300 shadow dark:bg-gray-200">
          </div>
        </div>
      </label>
    </div>

    <!-- Version Selectors -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div>
        <label for="versionA" class="block text-sm font-medium mb-1">Bible A (Left)</label>
        <select id="versionA" class="w-full border rounded px-3 py-2 dark:bg-gray-800 dark:border-gray-600">
          <option disabled selected value="">Select Bible A</option>

        </select>
      </div>
      <div>
        <label for="versionB" class="block text-sm font-medium mb-1">Bible B (Right)</label>
        <select id="versionB" class="w-full border rounded px-3 py-2 dark:bg-gray-800 dark:border-gray-600">
          <option disabled selected value="">Select Bible B</option>
        </select>
      </div>
    </div>

    <!-- Book Selector and Load Button -->
    <div class="flex flex-col sm:flex-row items-start sm:items-end gap-4 mb-6">
      <div class="flex-1">
        <label for="bookSelect" class="block text-sm font-medium mb-1">Book</label>
        <select id="bookSelect" class="w-full border rounded px-3 py-2 dark:bg-gray-800 dark:border-gray-600" disabled>
          <option value="">Select Book</option>
        </select>
      </div>

      <div class="flex-1">
        <label for="chapterSelect" class="block text-sm font-medium mb-1">Chapter</label>
        <select id="chapterSelect" class="w-full border rounded px-3 py-2 dark:bg-gray-800 dark:border-gray-600"
          disabled>
          <option value="">Select Chapter</option>
        </select>
      </div>

      <button id="loadBtn"
        class="w-full sm:w-auto bg-yellow-400 hover:bg-yellow-500 px-4 py-2 rounded text-black disabled:opacity-50"
        disabled>
        Load
      </button>
    </div>

    <!-- Toggles and TTS Dialect -->
    <div class="flex flex-wrap items-center gap-4 mb-4">
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" id="togglePinyin" checked />
        <span>Show Mandarin Pinyin</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" id="toggleCantonese" checked />
        <span>Show Cantonese Romanization</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" id="toggleTTS" checked />
        <span>Enable Text-to-Speech</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <span>TTS Dialect</span>
        <select id="ttsLangSelect" class="border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-600 text-sm">
          <option value="zh-CN">Mandarin</option>
          <option value="zh-HK">Cantonese</option>
        </select>
      </label>
      <button id="copyPermalink"
        class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
        🔗 Copy Permalink
      </button>
    </div>

    <!-- Chapter Title -->
    <h2 id="chapterTitle" class="text-xl font-bold mb-2">—</h2>

    <!-- Column Headers -->
    <div class="grid grid-cols-1 sm:grid-cols-2 text-sm font-semibold border-b pb-2 mb-2 dark:border-gray-700">
      <div id="titleA">Bible A</div>
      <div id="titleB">Bible B</div>
    </div>

    <!-- Verse Comparison Container -->
    <div id="comparisonContainer" class="divide-y divide-gray-200 dark:divide-gray-700"></div>

    <!-- Toast Notification -->
    <div id="toast"
      class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-black text-white px-4 py-2 rounded shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 z-50 text-sm">
    </div>
  </div>

  <!-- Footer (always visible at bottom) -->
  <footer
    style="position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 0.75rem; color: rgba(0, 0, 0, 0.3); font-weight: 300; z-index: 1000; pointer-events: none;">
    &copy; 2025 黄俊杰 All rights reserved.
  </footer>

  <!-- Shared template for all version options -->
  <template id="version-options">
    <!-- Arabic 🇸🇦 -->
    <option value="ar_svd" data-lang="ara">🇸🇦 Arabic (ar_svd)</option>
    <!-- Chinese 🇨🇳 -->
    <option value="zh_cuv" data-lang="chi">🇨🇳 CUV (zh_cuv)</option>
    <option value="zh_ncv" data-lang="chi">🇨🇳 NCV (zh_ncv)</option>
    <!-- German 🇩🇪 -->
    <option value="de_schlachter" data-lang="ger">🇩🇪 Schlachter (de_schlachter)</option>
    <!-- Greek 🇬🇷 -->
    <option value="el_greek" data-lang="gre">🇬🇷 Modern Greek (el_greek)</option>
    <!-- English 🇬🇧 -->
    <option value="en_bbe" data-lang="eng">🇬🇧 Basic English (en_bbe)</option>
    <option value="en_kjv" data-lang="eng">🇬🇧 King James (en_kjv)</option>
    <!-- Esperanto 🌐 -->
    <option value="eo_esperanto" data-lang="epo">🌐 Esperanto (eo_esperanto)</option>
    <!-- Spanish 🇪🇸 -->
    <option value="es_rvr" data-lang="spa">🇪🇸 Reina Valera (es_rvr)</option>
    <!-- Finnish 🇫🇮 -->
    <option value="fi_finnish" data-lang="fin">🇫🇮 Finnish Bible (fi_finnish)</option>
    <option value="fi_pr" data-lang="fin">🇫🇮 Pyhä Raamattu (fi_pr)</option>
    <!-- French 🇫🇷 -->
    <option value="fr_apee" data-lang="fre">🇫🇷 Bible de l'Épée (fr_apee)</option>
    <!-- Korean 🇰🇷 -->
    <option value="ko_ko" data-lang="kor">🇰🇷 Korean Version (ko_ko)</option>
    <!-- Portuguese 🇵🇹 -->
    <option value="pt_aa" data-lang="por">🇵🇹 Almeida AA (pt_aa)</option>
    <option value="pt_acf" data-lang="por">🇵🇹 Almeida ACF (pt_acf)</option>
    <option value="pt_nvi" data-lang="por">🇵🇹 NVI (pt_nvi)</option>
    <!-- Romanian 🇷🇴 -->
    <option value="ro_cornilescu" data-lang="rom">🇷🇴 Cornilescu (ro_cornilescu)</option>
    <!-- Russian 🇷🇺 -->
    <option value="ru_synodal" data-lang="rus">🇷🇺 Синодальный (ru_synodal)</option>
    <!-- Vietnamese 🇻🇳 -->
    <option value="vi_vietnamese" data-lang="vie">🇻🇳 Tiếng Việt (vi_vietnamese)</option>
  </template>

  <!-- Script to clone options into both selects -->
  <script>
    const template = document.getElementById('version-options').content;
    const selects = [document.getElementById('versionA'), document.getElementById('versionB')];
    selects.forEach(sel => {
      // clone all children of the template into each select
      sel.append(...Array.from(template.cloneNode(true).children));
    });
  </script>

  <script type="module">
    import toJyutping from 'https://unpkg.com/to-jyutping@3.1.1?module';

    const toggle = document.getElementById('darkModeToggle');
    toggle.addEventListener('change', () => {
      document.documentElement.classList.toggle('dark', toggle.checked);
      document.querySelector('.dot').style.transform = toggle.checked ? 'translateX(100%)' : 'translateX(0)';
    });

    function getBibleVersionURL(languageKey) {
      return `https://raw.githubusercontent.com/victorzhunjie/parallel-bible/refs/heads/main/bible/${languageKey}.json`
    }
    const loadedBibles = {};
    const versionA = document.getElementById('versionA');
    const versionB = document.getElementById('versionB');
    const bookSelect = document.getElementById('bookSelect');
    const loadBtn = document.getElementById('loadBtn');
    const queryWordSpan = document.getElementById('queryWord');
    const chapterTitle = document.getElementById('chapterTitle');
    const titleA = document.getElementById('titleA');
    const titleB = document.getElementById('titleB');
    const comparisonContainer = document.getElementById('comparisonContainer');
    const togglePinyin = document.getElementById('togglePinyin');
    const toggleCantonese = document.getElementById('toggleCantonese');
    const toggleTTS = document.getElementById('toggleTTS');
    const ttsLangSelect = document.getElementById('ttsLangSelect');

    // Map of Bible version keys to TTS language codes
    const ttsLangMap = {
      'ar_svd': 'ar-SA',
      'zh_cuv': 'zh-CN',
      'zh_ncv': 'zh-CN',
      'de_schlachter': 'de-DE',
      'el_greek': 'el-GR',
      'en_bbe': 'en-US',
      'en_kjv': 'en-US',
      'eo_esperanto': 'eo',
      'es_rvr': 'es-ES',
      'fi_finnish': 'fi-FI',
      'fi_pr': 'fi-FI',
      'fr_apee': 'fr-FR',
      'ko_ko': 'ko-KR',
      'pt_aa': 'pt-PT',
      'pt_acf': 'pt-PT',
      'pt_nvi': 'pt-PT',
      'ro_cornilescu': 'ro-RO',
      'ru_synodal': 'ru-RU',
      'vi_vietnamese': 'vi-VN',
    };

    async function importBible(versionKey) {
      if (loadedBibles[versionKey]) return loadedBibles[versionKey];
      const res = await fetch(getBibleVersionURL(versionKey));
      const json = await res.json();
      loadedBibles[versionKey] = json;
      return json;
    }

    async function tryEnableBookSelect() {
      const verA = versionA.value;
      const verB = versionB.value;
      if (verA && verB) {
        const jsonA = await importBible(verA);
        bookSelect.innerHTML = jsonA
          .map((book, idx) => `<option value="${idx}">${book.name}</option>`)
          .join('');
        bookSelect.disabled = false;
        loadBtn.disabled = false;
        comparisonContainer.innerHTML = '';
        chapterTitle.textContent = '—';
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('opacity-0');
      toast.classList.add('opacity-100');
      setTimeout(() => {
        toast.classList.remove('opacity-100');
        toast.classList.add('opacity-0');
      }, 2500);
    }

    versionA.addEventListener('change', tryEnableBookSelect);
    versionB.addEventListener('change', tryEnableBookSelect);

    bookSelect.addEventListener('change', () => {
      const verA = versionA.value;
      const idxBook = parseInt(bookSelect.value, 10);
      const chapterSelect = document.getElementById('chapterSelect');
      chapterSelect.innerHTML = '<option value="">Select Chapter</option>';

      if (!verA || isNaN(idxBook)) {
        chapterSelect.disabled = true;
        return;
      }

      importBible(verA).then(json => {
        const chapters = json[idxBook]?.chapters || [];
        chapterSelect.innerHTML += chapters.map((_, i) =>
          `<option value="${i}">Chapter ${i + 1}</option>`).join('');
        chapterSelect.disabled = false;
      });
    });

    loadBtn.addEventListener('click', async () => {
      const verA = versionA.value;
      const verB = versionB.value;
      const idxBook = parseInt(bookSelect.value, 10);
      const chapIdx = parseInt(document.getElementById('chapterSelect').value, 10);

      const bookName = bookSelect.selectedOptions[0]?.text || '';
      queryWordSpan.textContent = bookName.toLowerCase();

      if (!verA || !verB || isNaN(idxBook) || isNaN(chapIdx)) {

        console.log('---verA:', verA, 'verB:', verB, 'idxBook:', idxBook, 'chapIdx:', chapIdx);

        alert('Please select both Bible versions and a book.');
        return;
      }

      const langA = verA; // use version key directly
      const langB = verB;

      const [jsonA, jsonB] = await Promise.all([
        importBible(verA),
        importBible(verB)
      ]);

      const bookDataA = jsonA[idxBook];
      const bookDataB = jsonB[idxBook];

      const versesA = bookDataA.chapters[chapIdx] || [];
      const versesB = bookDataB.chapters[chapIdx] || [];

      chapterTitle.textContent = `${bookDataA.name} ${chapIdx + 1}`;
      titleA.textContent = versionA.selectedOptions[0].text;
      titleB.textContent = versionB.selectedOptions[0].text;

      comparisonContainer.innerHTML = '';
      const maxVerses = Math.max(versesA.length, versesB.length);

      for (let i = 0; i < maxVerses; i++) {
        const rowClass = (i % 2 === 0)
          ? 'bg-white dark:bg-gray-800'
          : 'bg-gray-100 dark:bg-gray-700';

        const verseNumber = `<span class="font-semibold">${i + 1}</span>`;
        const textA = versesA[i] ?? '#';
        const textB = versesB[i] ?? '#';

        let cellA = `<div class="text-gray-900 dark:text-gray-100">${verseNumber} ${textA}</div>`;
        let cellB = `<div class="text-gray-900 dark:text-gray-100">${verseNumber} ${textB}</div>`;

        const langAData = versionA.selectedOptions[0].dataset.lang;
        const langBData = versionB.selectedOptions[0].dataset.lang;

        if (langAData === 'chi' && versesA[i]) {
          if (togglePinyin.checked) {
            const pinyinA = window.pinyinPro.pinyin(versesA[i], { toneType: 'none', type: 'array' }).join(' ');
            cellA += `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1 pinyin">${pinyinA}</div>`;
          }
          if (toggleCantonese.checked && toJyutping) {
            const cantoA = toJyutping.getJyutpingText(versesA[i]);
            cellA += `<div class="text-xs text-indigo-500 dark:text-indigo-300 mt-1 cantonese">${cantoA}</div>`;
          }
        }

        if (langBData === 'chi' && versesB[i]) {
          if (togglePinyin.checked) {
            const pinyinB = window.pinyinPro.pinyin(versesB[i], { toneType: 'none', type: 'array' }).join(' ');
            cellB += `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1 pinyin">${pinyinB}</div>`;
          }
          if (toggleCantonese.checked && toJyutping) {
            const cantoB = toJyutping.getJyutpingText(versesB[i]);
            cellB += `<div class="text-xs text-indigo-500 dark:text-indigo-300 mt-1 cantonese">${cantoB}</div>`;
          }
        }

        const ttsA = `<button class="text-blue-500 dark:text-blue-300 text-xs mt-1 speak-btn" data-text="${textA}" data-lang="${langA}" style="display: ${toggleTTS.checked ? 'inline-block' : 'none'}">🔊</button>`;
        const ttsB = `<button class="text-blue-500 dark:text-blue-300 text-xs mt-1 speak-btn" data-text="${textB}" data-lang="${langB}" style="display: ${toggleTTS.checked ? 'inline-block' : 'none'}">🔊</button>`;

        comparisonContainer.innerHTML += `
        <div class="${rowClass} grid grid-cols-1 sm:grid-cols-2 px-2 py-1">
          <div>${cellA}${ttsA}</div>
          <div>${cellB}${ttsB}</div>
        </div>`;
      }

      document.querySelectorAll('.speak-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const text = btn.dataset.text;
          const langKey = btn.dataset.lang;
          const utterance = new SpeechSynthesisUtterance(text);

          const chosenDialect = ttsLangMap[langKey] === 'zh-CN' ? ttsLangSelect.value : ttsLangMap[langKey] || 'en-US';
          utterance.lang = chosenDialect;

          speechSynthesis.cancel();
          speechSynthesis.speak(utterance);
        });
      });

      togglePinyin.dispatchEvent(new Event('change'));
      toggleCantonese.dispatchEvent(new Event('change'));
      toggleTTS.dispatchEvent(new Event('change'));

      const newParams = new URLSearchParams();
      newParams.set('bible1', verA);
      newParams.set('bible2', verB);
      newParams.set('book', idxBook);
      newParams.set('chapter', chapIdx);

      window.history.replaceState(null, '', `${window.location.pathname}?${newParams.toString()}`);
    });

    togglePinyin.addEventListener('change', () => {
      document.querySelectorAll('.pinyin').forEach(el => {
        el.style.display = togglePinyin.checked ? 'block' : 'none';
      });
    });

    toggleCantonese.addEventListener('change', () => {
      document.querySelectorAll('.cantonese').forEach(el => {
        el.style.display = toggleCantonese.checked ? 'block' : 'none';
      });
    });

    toggleTTS.addEventListener('change', () => {
      document.querySelectorAll('.speak-btn').forEach(btn => {
        btn.style.display = toggleTTS.checked ? 'inline-block' : 'none';
      });
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const b1 = params.get('bible1');
      const b2 = params.get('bible2');
      const bookParam = params.get('book');
      const chapterParam = params.get('chapter');

      if (b1 && b2 && bookParam !== null) {
        // 1) set the versions
        versionA.value = b1;
        versionB.value = b2;

        // 2) enable/populate books
        await tryEnableBookSelect();

        const idx = Number(bookParam);
        if (!isNaN(idx) && bookSelect.options[idx]) {
          // 3) pick the book
          bookSelect.value = idx;
          bookSelect.dispatchEvent(new Event('change'));

          // 4) wait for chapters to be populated...
          const waitForChapterDropdown = setInterval(() => {
            const chapterSelect = document.getElementById('chapterSelect');
            if (chapterSelect.options.length > 1) {
              clearInterval(waitForChapterDropdown);
              // 5) now it's safe to set the chapter and click Load
              if (!isNaN(chapterParam)) {
                chapterSelect.value = chapterParam;
              }
              loadBtn.click();
            }
          }, 100);
        }
      }
    });

    // Copy permalink button logic
    document.getElementById('copyPermalink').addEventListener('click', () => {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Permalink copied to clipboard!');
      }).catch(err => {
        console.error('Copy failed:', err);
        showToast('❌ Failed to copy permalink.');
      });
    });
  </script>
</body>

</html>
